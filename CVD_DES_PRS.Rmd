---
title: "PRS-revised PCE in DES model for ASCVD"
author: "RIPS CVD modeling team"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
  pdf_document: default
---

# Preparation

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
load.lib<-c("reshape2","tidyverse","ggrepel","dampack","kableExtra","flexsurv","readxl","haven","janitor","here","parallel", "Rcpp", "ggpubr")
install.lib<-load.lib[!load.lib %in% installed.packages()]
for(lib in install.lib) install.packages(lib,dependencies=TRUE)
sapply(load.lib,require,character=TRUE)
library(simmer)
select <- dplyr::select

sourceCpp("ASCVD_RIPS.cpp")
options("scipen"=1000, "digits"=4)
```

## Inputs

Spahillari, et al. (2020)

```{r inputs}
vN = 100000
vHorizon = 10
annual_discount_rate = 0.03
wtp = 100000
CPI2017 = 245.12
CPI2019 = 255.657
CPI2023 = 302.408

## events from paper 2017
rrStatinsASCVD = 0.79
rrStatinsASCVD_low = 0.77
rrStatinsASCVD_upp = 0.81
rrStatinsASCVD_dist = "lnorm"

hrAfterASCVD = 1.9
hrAfterASCVD_low = 1.60
hrAfterASCVD_upp = 2.40 
hrAfterASCVD_dist = "lnorm" # log-normal

pFatalASCVD_f_young = 0.09
pFatalASCVD_f_young_dist = "beta"

pFatalASCVD_f_old = 0.3
pFatalASCVD_f_old_dist = "beta"

pFatalASCVD_m_young = 0.14
pFatalASCVD_m_young_dist = "beta"

pFatalASCVD_m_old = 0.25
pFatalASCVD_m_old_dist = "beta"

pMildAdverse = 0.047
pMildAdverse_low = 0.047*0.85 
pMildAdverse_upp = 0.047*1.15
pMildAdverse_dist = "beta"

pMajorAdverse = 0.006/100
pMajorAdverse_low = 0.006/100*0.85
pMajorAdverse_upp = 0.006/100*1.15
pMajorAdverse_dist = "beta"

pMajorAdverseBeingFatal = 0.09/100
pMajorAdverseBeingFatal_low = 0.09/100*0.85
pMajorAdverseBeingFatal_upp = 0.09/100*1.15
pMajorAdverseBeingFatal_dist = "beta"

## utility
uHealthy = 1
uAfterASCVD = 0.773
uAfterASCVD_low = 0.773*0.85
uAfterASCVD_upp = 0.773*1.15
uAfterASCVD_dist = "beta"

uHealthyStatin = 0.996
uHealthyStatin_low = 0.991
uHealthyStatin_upp = 1.000
uHealthyStatin_dist = "beta"

uPenaltyMildAdverse = -0.0055
uPenaltyMajorAdverse = -0.0383

uDeath = 0

# *Costs -------------------------------------------------------------------
cost_year = 2023
tbl_CPI <- read.csv("tbl_CPI.csv")

## cost(2017)
cyrAnnualFU = 2017
cAnnualFU = 3917 * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrAnnualFU]
cAnnualFU_low = 2611 * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrAnnualFU]
cAnnualFU_upp = 6528 * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrAnnualFU]
cAnnualFU_dist = "gamma"

cyrNonFatalASCVD = 2017
cNonFatalASCVD = 49348 * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrNonFatalASCVD]
cNonFatalASCVD_low = cNonFatalASCVD*0.85
cNonFatalASCVD_upp = cNonFatalASCVD*1.15
cNonFatalASCVD_dist = "gamma"

cyrFatalASCVD = 2017
cFatalASCVD = 16760 * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrFatalASCVD]
cFatalASCVD_low = cFatalASCVD*0.85
cFatalASCVD_upp = cFatalASCVD*1.15
cFatalASCVD_dist = "gamma"

cyrAnnualStatin = 2017
cAnnualStatin = 84 * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrAnnualStatin]

cyrMildAdverse = 2017
cMildAdverse = 215 * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrMildAdverse]
cMildAdverse_low = 196 * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrMildAdverse]
cMildAdverse_upp = 326 * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrMildAdverse]
cMildAdverse_dist = "gamma"

cyrMajorAdverse = 2017
cMajorAdverse = 8486 * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrMajorAdverse]
cMajorAdverse_low = 6920 * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrMajorAdverse]
cMajorAdverse_upp = 10314 * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrMajorAdverse]
cMajorAdverse_dist = "gamma"

### sourceï¼šAgency for Healthcare Research and Quality. Mean expenditure per person by age groups United States, 1996 to 2020. Medical Expenditure Panel Survey.(2020)
cyrBgNonCVD = 2020
# Input data
x <- c(31.5, 55, 80)
y <- c(3901, 8693, 12441) * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrBgNonCVD]

# Perform linear regression on the original data
model_bgcost <- lm(y ~ x)
intercept_bgcost = coef(model_bgcost)[1]
slope_bgcost = coef(model_bgcost)[2]

# https://www.cdc.gov/nchs/hus/topics/heart-disease-prevalence.htm
x <- c(50, 60, 70, 87.5)
y <- c(3.6/100, 9/100, 14.3/100, 24.2/100)
# Medical care costs among patients with established cardiovascular disease. Am J Manag Care. 2010.
cyrCVDcost = 2010
CVDcost = 18953 * tbl_CPI$CPI[tbl_CPI$Year == cost_year]/tbl_CPI$CPI[tbl_CPI$Year == cyrCVDcost]

model_CVDpct <- lm(y ~ x)
intercept_CVDpct = coef(model_CVDpct)[1]
slope_CVDpct = coef(model_CVDpct)[2]

c_healthy_coef_vec = c(CVDcost, intercept_bgcost, slope_bgcost, intercept_CVDpct, slope_CVDpct)

cHealthyAve = function(age, delta_time){
  f <- function(age) {((c_healthy_coef_vec[3] - c_healthy_coef_vec[5] * c_healthy_coef_vec[1])*age + (c_healthy_coef_vec[2] - c_healthy_coef_vec[4] * c_healthy_coef_vec[1])) / (1 - c_healthy_coef_vec[4] - c_healthy_coef_vec[5]*age)}
  
  return(integrate(f, age, age+delta_time)$value/delta_time)
}

## leave some spaces for PSA
```

```{r func}
cont_discount_rate <- -log(1- annual_discount_rate) # Yearly Time Scale
# discounted <- function(undiscounted, start_year, end_year, rate = cont_discount_rate)
# {
#   undiscounted/ (exp(-rate*(end_year-start_year)))
# }

discount <- function(value, A, ar=annual_discount_rate) value / (1+ar)^A

cont_discount <- function(start_time, delta_time){
  integrate(function(x) 1/((1+annual_discount_rate)^x), start_time, start_time + delta_time)$value
}
```

## PCE

We use the pooled cohort equation to calculate the risk of CVD from risk factors.

<https://github.com/spgarbet/desdt/tree/main/framingham>

## Sample population

We use NHANES study for the simulated population (limited by the PCE limits).

Use the 2017-2018 version: <https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?BeginYear=2017>

The sample is vascular-history-free:\
MCQ160d - Ever told you had angina/angina pectoris\
MCQ160e - Ever told you had heart attack\
MCQ160f - Ever told you had a stroke

```{r nhanes-clearance}
# source("building_nhanes_sample.R")
load("basepop.RData")
```

## Gompertz Model

We use Gompertz model based on US cause-deleted life table to predict the death age.

```{r source}
source("nonCVD_life_table.R")
load("life table/MarkovCVD_gompertz.RData")
```

# PRS

1.  add this Z score PRS rnorm(1,0,1) [-5,5]\
2.  use 1.73 Hazard ratio from Nature Medicine Paper

10-year ASCVD prob adding PRS risk:\
1 - exp(log(1 - pce_orig) \* 1.73\^PRS)

## pano

```{r, eval=FALSE}
# # 2018 guidelines high risk -- must use statins
# subset(nhanes_sample_pano, LBDLDL >= 190 | diabetes_rollup == 1 | pce_orig >= 0.2)
# 
# # low risk -- needn't need use statins
# subset(nhanes_sample_pano, LBDLDL < 190 & diabetes_rollup != 1 & pce_orig < 0.05)
# 
# # borderline risk 0.05-0.075
# hist(subset(nhanes_sample_pano,LBDLDL < 190 & diabetes_rollup != 1 & pce_orig >= 0.05 & pce_orig < 0.075)$pce_prs)
# mean(subset(nhanes_sample_pano,LBDLDL < 190 & diabetes_rollup != 1 & pce_orig >= 0.05 & pce_orig < 0.075)$pce_prs > 0.075)
# mean(subset(nhanes_sample_pano,LBDLDL < 190 & diabetes_rollup != 1 & pce_orig >= 0.05 & pce_orig < 0.075)$pce_prs < 0.05)
# mean(subset(nhanes_sample_pano,LBDLDL < 190 & diabetes_rollup != 1 & pce_orig >= 0.05 & pce_orig < 0.075)$pce_prs > 0.2)
# 
# # Intermediate risk
# hist(subset(nhanes_sample_pano,LBDLDL < 190 & diabetes_rollup != 1 & pce_orig >= 0.075 & pce_orig < 0.2)$pce_prs)
# mean(subset(nhanes_sample_pano,LBDLDL < 190 & diabetes_rollup != 1 & pce_orig >= 0.075 & pce_orig < 0.2)$pce_prs > 0.2)
# mean(subset(nhanes_sample_pano,LBDLDL < 190 & diabetes_rollup != 1 & pce_orig >= 0.075 & pce_orig < 0.2)$pce_prs < 0.05)
```

## Detailed camparison plots

```{r}
hex_colors = scales::hue_pal()(2)
# Total
fig_full <- nhanes_sample_pano %>%
  pivot_longer(cols = starts_with("pce_"), names_to = "PCE_type", names_prefix = "pce_", values_to = "prob_10yr") %>%
  ggplot(aes(x=prob_10yr, color = PCE_type)) +
  annotate("rect", xmin = -Inf, xmax = 0.075, ymin = -Inf, ymax = Inf, fill = "black", alpha =0.1) +
  annotate("rect", xmin = 0.075, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "yellow", alpha =0.1) +
  annotate("text", x = 0.075, y = Inf, label = "Statins", hjust = -0.4, vjust = 1.5, size = 3) +
  annotate("text", x = 0.075, y = Inf, label = "No Statins", hjust = 1, vjust = 1.5, size = 3) +
  geom_histogram(aes(y = ..count../sum(..count..), fill = PCE_type), 
                 boundary = 0, binwidth = 0.025, alpha = 0.5, position="identity")  +
  geom_vline(xintercept = 0.075, linetype="dotted", 
             color = "red") +
  scale_fill_manual(labels = c("PCE Only", "PCE + PRS"), values = hex_colors, name = "") +
  scale_color_manual(labels = c("PCE Only", "PCE + PRS"), values = hex_colors, name = "") +
  scale_x_continuous(labels = scales::percent, limits = c(0, 1)) +
  labs(y = "Proportion", x = "10-yr ASCVD risk",
       title = "Distribution of 10-yr ASCVD Risk (w/o + w/ PRS)") + 
  theme_bw()

## PRS won't change the decision
# High Risk, must use statins 
fig_high <- nhanes_sample_pano %>%
  filter(LBDLDL >= 190 | diabetes_rollup == 1 | pce_orig >= 0.2) %>%
  pivot_longer(cols = starts_with("pce_"), names_to = "PCE_type", names_prefix = "pce_", values_to = "prob_10yr") %>%
  mutate(PCE_type = ordered(PCE_type, labels = c("PCE Only", "PCE + PRS"))) %>%
  ggplot(aes(x=prob_10yr, color = PCE_type)) +
  annotate("rect", xmin = -Inf, xmax = 0.075, ymin = -Inf, ymax = Inf, fill = "black", alpha =0.1) +
  annotate("rect", xmin = 0.075, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "yellow", alpha =0.1) +
  annotate("text", x = 0.075, y = Inf, label = "Statins", hjust = -0.4, vjust = 1.5, size = 3) +
  annotate("text", x = 0.075, y = Inf, label = "No Statins", hjust = 1, vjust = 1.5, size = 3) +
  geom_histogram(aes(y = ..count../sum(..count..), fill = PCE_type), 
                 boundary = 0, binwidth = 0.025, alpha = 0.5, position="identity")  +
  geom_vline(xintercept = 0.075, linetype="dotted", 
             color = "red") +
  scale_fill_manual(labels = c("PCE Only", "PCE + PRS"), values = hex_colors, name = "") +
  scale_color_manual(labels = c("PCE Only", "PCE + PRS"), values = hex_colors, name = "") +
  scale_x_continuous(labels = scales::percent, limits = c(0, 1)) +
  labs(y = "Proportion", x = "10-yr ASCVD risk",
       title = "High Risk Group (PCE > 20%)") +
  theme_bw()

## Intermediate Risk
fig_intermediate <- nhanes_sample_pano %>%
  filter(LBDLDL < 190 & diabetes_rollup != 1 & pce_orig >= 0.075 & pce_orig < 0.2) %>%
  pivot_longer(cols = starts_with("pce_"), names_to = "PCE_type", names_prefix = "pce_", values_to = "prob_10yr") %>%
  ggplot(aes(x=prob_10yr, color = PCE_type)) +
  annotate("rect", xmin = -Inf, xmax = 0.075, ymin = -Inf, ymax = Inf, fill = "black", alpha =0.1) +
  annotate("rect", xmin = 0.075, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "yellow", alpha =0.1) +
  annotate("text", x = 0.075, y = Inf, label = "Statins", hjust = -0.4, vjust = 1.5, size = 3) +
  annotate("text", x = 0.075, y = Inf, label = "No Statins", hjust = 1, vjust = 1.5, size = 3) +
  geom_histogram(aes(y = ..count../sum(..count..), fill = PCE_type), 
                 boundary = 0, binwidth = 0.025, alpha = 0.5, position="identity")  +
  geom_vline(xintercept = 0.075, linetype="dotted", 
             color = "red") +
  scale_fill_manual(labels = c("PCE Only", "PCE + PRS"), values = hex_colors, name = "") +
  scale_color_manual(labels = c("PCE Only", "PCE + PRS"), values = hex_colors, name = "") +
  scale_x_continuous(labels = scales::percent, limits = c(0, 1)) +
  labs(y = "Proportion", x = "10-yr ASCVD risk",
       title = "Intermediate Risk Group (PCE 7.5%-20%)") + 
  theme_bw()

## Borderline Risk, 5% - 7.5%
fig_borderline <- nhanes_sample_pano %>%
  filter(LBDLDL < 190 & diabetes_rollup != 1 & pce_orig >= 0.05 & pce_orig < 0.075) %>%
  pivot_longer(cols = starts_with("pce_"), names_to = "PCE_type", names_prefix = "pce_", values_to = "prob_10yr") %>%
  mutate(PCE_type = ordered(PCE_type, labels = c("PCE Only", "PCE + PRS"))) %>%
  ggplot(aes(x=prob_10yr, color = PCE_type)) +
  annotate("rect", xmin = -Inf, xmax = 0.075, ymin = -Inf, ymax = Inf, fill = "black", alpha =0.1) +
  annotate("rect", xmin = 0.075, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "yellow", alpha =0.1) +
  annotate("text", x = 0.075, y = Inf, label = "Statins", hjust = -0.4, vjust = 1.5, size = 3) +
  annotate("text", x = 0.075, y = Inf, label = "No Statins", hjust = 1, vjust = 1.5, size = 3) +
  geom_histogram(aes(y = ..count../sum(..count..), fill = PCE_type), 
                 boundary = 0, binwidth = 0.025, alpha = 0.5, position="identity")  +
  geom_vline(xintercept = 0.075, linetype="dotted", 
             color = "red") +
  scale_fill_manual(labels = c("PCE Only", "PCE + PRS"), values = hex_colors, name = "") +
  scale_color_manual(labels = c("PCE Only", "PCE + PRS"), values = hex_colors, name = "") +
  scale_x_continuous(labels = scales::percent, limits = c(0, 1)) +
  labs(y = "Proportion", x = "10-yr ASCVD risk",
       title = "Borderline Risk Group (PCE 5%-7.5%)") +
  theme_bw()

# Low Risk, < 5%
fig_low <- nhanes_sample_pano %>%
  filter(LBDLDL < 190 & diabetes_rollup != 1 & pce_orig < 0.05) %>%
  pivot_longer(cols = starts_with("pce_"), names_to = "PCE_type", names_prefix = "pce_", values_to = "prob_10yr") %>%
  ggplot(aes(x=prob_10yr, color = PCE_type)) +
  annotate("rect", xmin = -Inf, xmax = 0.075, ymin = -Inf, ymax = Inf, fill = "black", alpha =0.1) +
  annotate("rect", xmin = 0.075, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "yellow", alpha =0.1) +
  annotate("text", x = 0.075, y = Inf, label = "Statins", hjust = -0.4, vjust = 1.5, size = 3) +
  annotate("text", x = 0.075, y = Inf, label = "No Statins", hjust = 1, vjust = 1.5, size = 3) +
  geom_histogram(aes(y = ..count../sum(..count..), fill = PCE_type), 
                 boundary = 0, binwidth = 0.025, alpha = 0.5, position="identity")  +
  geom_vline(xintercept = 0.075, linetype="dotted", 
             color = "red") +
  scale_fill_manual(labels = c("PCE Only", "PCE + PRS"), values = hex_colors, name = "") +
  scale_color_manual(labels = c("PCE Only", "PCE + PRS"), values = hex_colors, name = "") +
  scale_x_continuous(labels = scales::percent, limits = c(0, 1)) +
  labs(y = "Proportion", x = "10-yr ASCVD risk",
       title = "Low-Risk Group (PCE < 5%)") + 
  theme_bw()

ggsave(fig_full, filename = "fig_full.pdf", width = 8, height = 5)
ggsave(fig_high, filename = "fig_high.pdf", width = 8, height = 5)
ggsave(fig_intermediate, filename = "fig_intermediate.pdf", width = 8, height = 5)
ggsave(fig_borderline, filename = "fig_borderline.pdf", width = 8, height = 5)
ggsave(fig_low, filename = "fig_low.pdf", width = 8, height = 5)

fig_comb <- ggarrange(fig_low, fig_borderline, fig_intermediate, fig_high,
                      nrow = 2, ncol = 2,
                      legend = "bottom", common.legend = T)
ggsave(fig_comb, filename = "fig_comb.pdf", width = 12, height = 7)

```

## PRS Percentile

```{r}
nhanes_sample_pano$PCE_group = cut(nhanes_sample_pano$pce_orig, 
                               breaks = c(0, 0.05, 0.075, 0.2, 1), 
                               include.lowest = TRUE, 
                               labels = c("low risk (< 5%) ","Borderline Risk (5 ~ 7.5%)", "Intermediate Risk (7.5 ~ 20%)", "High Risk (> 20%)"))

nhanes_sample_pano %>%
  ggplot(aes(x = pnorm(PRS), y = pce_prs)) +
  # geom_point() +
  geom_smooth(se = TRUE) +
  facet_grid(. ~ PCE_group) +
  theme_bw()


```

# Intervention

strategy 0. use statins as 2018 ACC/AHA

Individuals(age 40 - 80):

-   with diabetes, or

-   low-density lipoprotein cholesterol level \>= 190 mg/dl, or

-   estimated 10-year ASCVD risk greater than or equal to 7.5%.

Statins will be taken until the ASCVD happen.

Adverse events:

Adverse events will happen immediately after using statins. The major adverse event will overlap the mild adverse event. The death caused by the major adverse event should happen immediately after the event.

Strategy 1. use statins as 2018 ACC/AHA, but use the PRS-revised PCE instead.

possible branches:

1.  survive until horizon

2.  die of background mortality before horizon

3.  get CVD, die of first-year ASCVD

4.  get CVD, die after first-year ASCVD event\

## Subgroup

| PCE subgroups     | PCE \< 5%       | PCE 5 - 7.5%    | PCE 7.5 - 20%   | PCE \> 20%      |
|---------------|---------------|---------------|---------------|---------------|
| subgroup weight   |                 |                 |                 |                 |
| change statin use | PRS-PCE \> 7.5% | PRS-PCE \> 7.5% | PRS-PCE \< 7.5% | PRS-PCE \< 7.5% |
| not change        |                 |                 |                 |                 |

```{r}
# PCE subgroup weight
nrow(subset(nhanes_sample_pano, pce_orig < 0.05))/nrow(nhanes_sample_pano)
nrow(subset(nhanes_sample_pano, pce_orig >= 0.05 & pce_orig < 0.075))/nrow(nhanes_sample_pano)
nrow(subset(nhanes_sample_pano, pce_orig >= 0.075 & pce_orig < 0.20))/nrow(nhanes_sample_pano)
nrow(subset(nhanes_sample_pano, pce_orig >= 0.2))/nrow(nhanes_sample_pano)

# PCE + PRS subgroup weight conditional on PCE group
nrow(subset(nhanes_sample_pano, pce_orig < 0.05 & pce_prs >= 0.075))/nrow(subset(nhanes_sample_pano, pce_orig < 0.05))
nrow(subset(nhanes_sample_pano, pce_orig >= 0.05 & pce_orig < 0.075 & pce_prs >= 0.075))/nrow(subset(nhanes_sample_pano, pce_orig >= 0.05 & pce_orig < 0.075))
nrow(subset(nhanes_sample_pano, pce_orig >= 0.075 & pce_orig < 0.20 & pce_prs < 0.075))/nrow(subset(nhanes_sample_pano, pce_orig >= 0.075 & pce_orig < 0.20))
nrow(subset(nhanes_sample_pano, pce_orig >= 0.2 & pce_prs < 0.075))/nrow(subset(nhanes_sample_pano, pce_orig >= 0.2))

nhanes_wt = data.frame(
  PCE_group = c(
    nrow(subset(nhanes_sample_pano, pce_orig < 0.05))/nrow(nhanes_sample_pano),
    nrow(subset(nhanes_sample_pano, pce_orig >= 0.05 & pce_orig < 0.075))/nrow(nhanes_sample_pano),
    nrow(subset(nhanes_sample_pano, pce_orig >= 0.075 & pce_orig < 0.20))/nrow(nhanes_sample_pano),
    nrow(subset(nhanes_sample_pano, pce_orig >= 0.2))/nrow(nhanes_sample_pano)),
  # on condition of PCE_group
  PRS_change = c(
    nrow(subset(nhanes_sample_pano, pce_orig < 0.05 & pce_prs >= 0.075))/nrow(subset(nhanes_sample_pano, pce_orig < 0.05)),
    nrow(subset(nhanes_sample_pano, pce_orig >= 0.05 & pce_orig < 0.075 & pce_prs >= 0.075))/nrow(subset(nhanes_sample_pano, pce_orig >= 0.05 & pce_orig < 0.075)),
    nrow(subset(nhanes_sample_pano, pce_orig >= 0.075 & pce_orig < 0.20 & pce_prs < 0.075))/nrow(subset(nhanes_sample_pano, pce_orig >= 0.075 & pce_orig < 0.20)),
    nrow(subset(nhanes_sample_pano, pce_orig >= 0.2 & pce_prs < 0.075))/nrow(subset(nhanes_sample_pano, pce_orig >= 0.2))))


```

```{r}
sim_ASCVD = function(strategy) {
  bind_cols(mod_main(n_pop = nrow(runcohort), strategy = strategy, 
                    horizon = vHorizon,
              disc_rate = annual_discount_rate,
              age_vec = runcohort$RIDAGEYR, 
              male_vec = runcohort$male, 
              race_vec = runcohort$race,
              diabetes_vec = runcohort$diabetes_rollup, 
              ldl_chol_vec = runcohort$LBDLDL,
              pce_orig_vec = runcohort$pce_orig, 
              pce_prs_vec = runcohort$pce_prs,
              rrStatinsASCVD = rrStatinsASCVD,
              pFatalASCVD_m_young = pFatalASCVD_m_old, 
              pFatalASCVD_m_old = pFatalASCVD_m_old,
              pFatalASCVD_f_young = pFatalASCVD_f_young, 
              pFatalASCVD_f_old = pFatalASCVD_f_old,
              pMildAdverse = pMajorAdverse, 
              pMajorAdverse = pMajorAdverse, 
              pMajorAdverseBeingFatal = pMajorAdverseBeingFatal,
              parameters_f_shape = parameters_f$shape,
              parameters_f_rate = parameters_f$rate,
              parameters_m_shape = parameters_m$shape,
              parameters_m_rate = parameters_m$rate,
              parameters_f_hr_shape = parameters_f_hr$shape, 
              parameters_f_hr_rate = parameters_f_hr$rate, 
              parameters_m_hr_shape = parameters_m_hr$shape,
              parameters_m_hr_rate = parameters_m_hr$rate, 
              uDeath = uDeath, uHealthy = uHealthy, 
              uAfterASCVD = uAfterASCVD,
              uHealthyStatin = uHealthyStatin, 
              uPenaltyMajorAdverse = uPenaltyMajorAdverse, 
              uPenaltyMildAdverse = uPenaltyMildAdverse,
              cAnnualStatin = cAnnualStatin, 
              cAnnualFU = cAnnualFU, cFatalASCVD = cFatalASCVD, 
              cNonFatalASCVD = cNonFatalASCVD, 
              cMildAdverse = cMildAdverse, cMajorAdverse = cMajorAdverse))}
```

```{r}
# PCE orig <5%
runcohort = nhanes_sample_lower_5_change
results_lower_5_change.1 = sim_ASCVD(1)
results_lower_5_change.0 = sim_ASCVD(0)

runcohort = nhanes_sample_lower_5_unchange
results_lower_5_unchange.0 = sim_ASCVD(0)

# PCE orig 5-7.5%
runcohort = nhanes_sample_5_7.5_change
results_5_7.5_change.1 = sim_ASCVD(1)
results_5_7.5_change.0 = sim_ASCVD(0)

runcohort = nhanes_sample_5_7.5_unchange
results_5_7.5_unchange.0 = sim_ASCVD(0)

# PCE orig 7.5-20%
runcohort = nhanes_sample_7.5_20_change
results_7.5_20_change.1 = sim_ASCVD(1)
results_7.5_20_change.0 = sim_ASCVD(0)

runcohort = nhanes_sample_7.5_20_unchange
results_7.5_20_unchange.0 = sim_ASCVD(0)

# PCE orig >20%
runcohort = nhanes_sample_greater_20_change
results_greater_20_change.1 = sim_ASCVD(1)
results_greater_20_change.0 = sim_ASCVD(0)

runcohort = nhanes_sample_greater_20_unchange
results_greater_20_unchange.0 = sim_ASCVD(0)

save(list=ls(pattern = 'results_'), file = "results_20240219_v2.RData")

# incremental

inc1 = colMeans(results_lower_5_change.1) - colMeans(results_lower_5_change.0)
inc2 = colMeans(results_5_7.5_change.1) - colMeans(results_5_7.5_change.0)
inc3 = colMeans(results_7.5_20_change.1) - colMeans(results_7.5_20_change.0)
inc4 = colMeans(results_greater_20_change.1) - colMeans(results_greater_20_change.0)
results_subgroup <- bind_rows(inc1, inc2, inc3, inc4)
write.csv(results_subgroup, file = "results_subgroup_v2.csv")

inc_cost_disc = c(inc1["cost_disc"], inc2["cost_disc"], inc3["cost_disc"], inc4["cost_disc"]) * nhanes_wt$PRS_change * nhanes_wt$PCE_group
inc_QALE_disc = c(inc1["QALE_disc"], inc2["QALE_disc"], inc3["QALE_disc"], inc4["QALE_disc"]) * nhanes_wt$PRS_change * nhanes_wt$PCE_group
inc_cost_disc/inc_QALE_disc
sum(inc_cost_disc)/sum(inc_QALE_disc)

# weight combination
# add PRS: strategy == 1
wt_results1 = colSums(
  rbind(
    rbind(colMeans(results_lower_5_change.1), colMeans(results_5_7.5_change.1), colMeans(results_7.5_20_change.1), colMeans(results_greater_20_change.1)) * nhanes_wt$PRS_change * nhanes_wt$PCE_group,
    rbind(colMeans(results_lower_5_unchange.0), colMeans(results_5_7.5_unchange.0), colMeans(results_7.5_20_unchange.0), colMeans(results_greater_20_unchange.0)) * (1-nhanes_wt$PRS_change) * nhanes_wt$PCE_group
    ))

# status quo: strategy == 0
wt_results0 = colSums(
  rbind(
    rbind(colMeans(results_lower_5_change.0), colMeans(results_5_7.5_change.0), colMeans(results_7.5_20_change.0), colMeans(results_greater_20_change.0)) * nhanes_wt$PRS_change * nhanes_wt$PCE_group,
    rbind(colMeans(results_lower_5_unchange.0), colMeans(results_5_7.5_unchange.0), colMeans(results_7.5_20_unchange.0), colMeans(results_greater_20_unchange.0)) * (1-nhanes_wt$PRS_change) * nhanes_wt$PCE_group
    ))

results_full <- bind_rows(wt_results0, wt_results1)
write.csv(results_full, file = "results_full_v2.csv")

# # validation
# subset(results1, mild_adverse != 0 | major_adverse != 0)
# 
# # horizon
# subset(results1, death == 0)
# subset(results1, death == 0 & ttdeath != 10)
# 
# # BG death
# subset(results1, BGdeath == 1)
# 
# # Fatal ASCVD
# subset(results1, fatal_ASCVD == 1)
# subset(results1, fatal_ASCVD == 1 & ASCVDdeath != 1)
# 
# # nonfatal ASCVD
# subset(results1, fatal_ASCVD == 0 & ASCVDdeath == 1)

# results1 = sim_ASCVD(1)
# results0 = sim_ASCVD(0)
# rbind(colMeans(results1), colMeans(results0)) %>%
#   kableExtra::kbl() %>%
#   kableExtra::kable_styling()
# 
# results1 = sim_ASCVD(1)
# results0 = sim_ASCVD(0)
# rbind(colMeans(results1), colMeans(results0)) %>% 
#   kableExtra::kbl() %>%
#   kableExtra::kable_styling()

```
