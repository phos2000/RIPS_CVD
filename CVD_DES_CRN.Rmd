---
title: "Common Random Number in DES simulation -- based on CVD model"
author: "Astrid Yu"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: "hide"
---

# Preparation

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
load.lib<-c("reshape2","tidyverse","ggrepel","dampack","kableExtra","flexsurv","readxl","haven","janitor","here","parallel")
install.lib<-load.lib[!load.lib %in% installed.packages()]
for(lib in install.lib) install.packages(lib,dependencies=TRUE)
sapply(load.lib,require,character=TRUE)
library(simmer)
select <- dplyr::select

options("scipen"=1000, "digits"=4)
```

## Inputs

Spahillari, et al. (2020)

```{r inputs}
params = list(
  ## basic/general from Stroke paper, 2023
  strategy = 0, # or 1
  vN = 1000,
  vHorizon = 10,
  discount_rate = 0.03,
  wtp = 100000,
  CPI2017 = 245.12,
  CPI2019 = 255.657,
  CPI2020 = 258.811,
  
  ## events from paper 2017
  rrStatinsASCVD = 0.79,
  rrStatinsASCVD_low = 0.77,
  rrStatinsASCVD_upp = 0.81,
  rrStatinsASCVD_dist = "lnorm",
  
  hrAfterASCVD = 1.9,
  hrAfterASCVD_low = 1.60,
  hrAfterASCVD_upp = 2.40, 
  hrAfterASCVD_dist = "lnorm", # log-normal
  
  mortalityFirstYearASCVD_female_young = 0.09,
  mortalityFirstYearASCVD_female_young_dist = "beta",
  
  mortalityFirstYearASCVD_female_old = 0.3,
  mortalityFirstYearASCVD_female_old_dist = "beta",
  
  mortalityFirstYearASCVD_male_young = 0.14,
  mortalityFirstYearASCVD_male_young_dist = "beta",
  
  mortalityFirstYearASCVD_male_old = 0.25,
  mortalityFirstYearASCVD_male_old_dist = "beta",
  
  pMildStatinAdverse = 0.047,
  pMildStatinAdverse_low = 0.047*0.85, 
  pMildStatinAdverse_upp = 0.047*1.15,
  pMildStatinAdverse_dist = "beta",
  
  pMajorStatinAdverse = 0.006/100,
  pMajorStatinAdverse_low = 0.006/100*0.85,
  pMajorStatinAdverse_upp = 0.006/100*1.15,
  pMajorStatinAdverse_dist = "beta",
  
  pMajorStatinAdverseBeingFatal = 0.09/100,
  pMajorStatinAdverseBeingFatal_low = 0.09/100*0.85,
  pMajorStatinAdverseBeingFatal_upp = 0.09/100*1.15,
  pMajorStatinAdverseBeingFatal_dist = "beta",

  ## utility
  uHealthy = 1,
  uAfterASCVD = 0.773,
  uAfterASCVD_low = 0.773*0.85,
  uAfterASCVD_upp = 0.773*1.15,
  uAfterASCVD_dist = "beta",
  
  uHealthyStatin = 0.996,
  uHealthyStatin_low = 0.991,
  uHealthyStatin_upp = 1.000,
  uHealthyStatin_dist = "beta",
  
  uPenaltyMildStatinAdverse = -0.0055,
  uPenaltyMajorStatinAdverse = -0.0383,
  
  uDeath = 0,
  
  ## cost(2017)
  cAnnualFU_afterASCVD = 3917,
  cAnnualFU_afterASCVD_low = 2611,
  cAnnualFU_afterASCVD_upp = 6528,
  cAnnualFU_afterASCVD_dist = "gamma",
  
  cNonFatalASCVD = 49348,
  cNonFatalASCVD_low = 49348*0.85,
  cNonFatalASCVD_upp = 49348*1.15,
  cNonFatalASCVD_dist = "gamma",
  
  cFatalASCVD = 16760,
  cFatalASCVD_low = 16760*0.85,
  cFatalASCVD_upp = 16760*1.15,
  cFatalASCVD_dist = "gamma",
  
  cAnnualStatin = 84,
  
  cMildStatinAdverse = 215,
  cMildStatinAdverse_low = 196,
  cMildStatinAdverse_upp = 326,
  cMildStatinAdverse_dist = "gamma",
  
  cMajorStatinAdverse = 8486,
  cMajorStatinAdverse_low = 6920, 
  cMajorStatinAdverse_upp = 10314,
  cMajorStatinAdverse_dist = "gamma",
  
  annual_discount_rate = 0.03,
  
  ### sourceï¼šAgency for Healthcare Research and Quality. Mean expenditure per person by age groups, United States, 1996 to 2020. Medical Expenditure Panel Survey.(2020)
  cHealthcareNonCVD_18_44 = 3901,
  cHealthcareNonCVD_45_64 = 8693,
  cHealthcareNonCVD_65 = 12441

)
## inflation
params$rInflation2017 = params$CPI2020 / params$CPI2017
params$rInflation2019 = params$CPI2020 / params$CPI2019

## leave some spaces for PSA
```

```{r func}
# simply change from prob to rate than to event
ProbToRate = function(prob, t){
  -log(1-prob)/t
}

RateToProb = function(rate, t){
  1 - exp(-rate*t)
}
# # what this t should be -- 10 years?
# # time unit: year
# rate = ProbToRate(pcr()/100)
# days = rexp(1,rate)

params$cont_discount_rate <- -log(1- params$annual_discount_rate) # Yearly Time Scale
discounted <- function(undiscounted, start_year, end_year, rate = params$cont_discount_rate)
{
  undiscounted/ (exp(-rate*(end_year-start_year)))
}

discount <- function(value, A, ar=params$annual_discount_rate) value / (1+ar)^A
```

## Random Number Generator

attributes and events for random:

| location                     | attributes/events    | without CRN                                                                                  | with CRN                                                                                                                                    |
|-----------------|-----------------|-----------------|--------------------|
| initialize_patient           | **nhanesNo**         | sample(1:nrow(nhanes_pop), 1, prob=1/nhanes_pop\$WTMEC2YR))                                  | nhanes_pop\$cum_weight = cumsum(nhanes_pop\$WTMEC2YR / sum(nhanes_pop\$WTMEC2YR))                                                           |
| years_till_death_without_CVD | **aDeathWithoutCVD** | rgompertz(1, shape, rate)                                                                    | qgompertz(inputs\$randomNums[(get_attribute(env,"patientID"))\*length(rCRN) + rCRN["rDeathWithoutCVD"]], shape, rate)                       |
| years_till_get_CVD           | **aGetCVD**          | rexp(1,ProbToRate(prob, 10))                                                                 | qexp(inputs\$randomNums[(get_attribute(env,"patientID"))\*length(rCRN) + rCRN["rGetCVD"]], ProbToRate(prob, 10))                            |
| years_till_death_of_ASCVD    | **aDeathOfASCVD**    | sample(0:1, 1, prob = c(1-inputs\$mortalityFirstYearASCVD, inputs\$mortalityFirstYearASCVD)) | ifelse(inputs\$randomNums[(get_attribute(env,"patientID"))\*length(rCRN) + rCRN["rDeathOfASCVD"]] \< inputs\$mortalityFirstYearASCVD, 1, 0) |
| years_till_death_after_ASCVD | **aDeathAfterASCVD** | rgompertz(1, shape, rate)                                                                    | qgompertz(inputs\$randomNums[(get_attribute(env,"patientID"))\*length(rCRN) + rCRN["rDeathAfterASCVD"]], shape, rate))                      |

Also, need to remind who this individual is inside the DES simulation: get_attribute(env, "patientID")

CRN will also lead to the same result for the same event. Right now we just loop once, if more will set more CRN.

```{r generator}
set.seed(114514)
rCRN = 1:8
names(rCRN) = c("nhanesNo", "rDeathWithoutCVD", "rGetCVD", "rDeathOfASCVD", "rDeathAfterASCVD", "rStatinsMildAdverse", "rStatinsMajorAdverse", "rDeathOfStatinsAdverse")

params_CRN = params

params_CRN$nRN = params_CRN$vN * length(rCRN)
params_CRN$randomNums = runif(params_CRN$nRN)
```

## Gompertz Model

We use Gompertz model based on US cause-deleted life table to predict the death age.

```{r source}
source("nonCVD_life_table.R")
```

```{r life-table-gompertz}
# # male
# 
# mltNonCVD_long = data.frame(Age = rep(NA, ceiling(sum(mlt2020_nonCVD$dx))), Death = rep(1, ceiling(sum(mlt2020_nonCVD$dx))))
# 
# start = 1
# for (age in 0:(nrow(mlt2020_nonCVD)-1)) {
#   n_row = round(mlt2020_nonCVD[age+1,"dx"])
#   mltNonCVD_long[seq(start,(n_row + start - 1)),"Age"] = age
#   start = start + n_row
# }
# 
# mltNonCVD_long = mltNonCVD_long %>% drop_na()
# 
# parameters_m = data.frame(
#   Age = mlt2020_nonCVD$Age,
#   shape=rep(NA,nrow(mlt2020_nonCVD)),
#   rate=rep(NA,nrow(mlt2020_nonCVD)))
# 
# 
# for (age in 0:nrow(mlt2020_nonCVD)-1) {
#   surv.data <- with(mltNonCVD_long[mltNonCVD_long$Age >= age,], Surv(Age, Death, origin=age))
#   surv.model <- flexsurvreg(surv.data ~ 1, dist="gompertz")
# 
#   parameters_m$shape[age+1] <- surv.model$coefficients[1]
#   parameters_m$rate[age+1] <- exp(surv.model$coefficients[2])
# }
# 
# # if start since 45-yr
# # pgompertz(cycle, parameters_m$shape[46], parameters_m$rate[46])
# 
# # female
# 
# fltNonCVD_long = data.frame(Age = rep(NA, ceiling(sum(flt2020_nonCVD$dx))), Death = rep(1, ceiling(sum(flt2020_nonCVD$dx))))
# 
# start = 1
# for (age in 0:(nrow(flt2020_nonCVD)-1)) {
#   n_row = round(flt2020_nonCVD[age+1,"dx"])
#   fltNonCVD_long[seq(start,(n_row + start - 1)),"Age"] = age
#   start = start + n_row
# }
# 
# fltNonCVD_long = fltNonCVD_long %>% drop_na()
# 
# parameters_f = data.frame(
#   Age = flt2020_nonCVD$Age,
#   shape=rep(NA,nrow(flt2020_nonCVD)),
#   rate=rep(NA,nrow(flt2020_nonCVD)))
# 
# 
# for (age in 0:nrow(flt2020_nonCVD)-1) {
#   surv.data <- with(fltNonCVD_long[fltNonCVD_long$Age >= age,], Surv(Age, Death, origin=age))
#   surv.model <- flexsurvreg(surv.data ~ 1, dist="gompertz")
# 
#   parameters_f$shape[age+1] <- surv.model$coefficients[1]
#   parameters_f$rate[age+1] <- exp(surv.model$coefficients[2])
# }

ageAtDeath <- function(currentAge, gender, inputs, patientID)
{
  # patientID = get_attribute(env, "patientID")
  currentAge_f <- floor(currentAge) #negative time to secular death issue
  
  # Male 1 FEMALE 2
  if(gender == 2){
    shape <- parameters_f$shape[currentAge_f+1]
    rate  <- parameters_f$rate[currentAge_f+1]
  } else {
    shape <- parameters_m$shape[currentAge_f+1]
    rate  <- parameters_m$rate[currentAge_f+1]
  }
  
  min(currentAge + ifelse(is.null(inputs$randomNums), rgompertz(1, shape, rate), qgompertz(inputs$randomNums[(patientID-1)*length(rCRN) + rCRN["rDeathWithoutCVD"]], shape, rate)), 100)
}

```

```{r gompertz-hr}
# # male
# mlt2020_hr = data.frame(Age = 0:(nrow(mlt2020_nonCVD)-1), qx = sapply(sapply(mlt2020_nonCVD$qx, ProbToRate, t = 1) * inputs$hrAfterASCVD, RateToProb, t = 1), lx = rep(0,nrow(mlt2020_nonCVD)), dx = rep(NA,nrow(mlt2020_nonCVD)))
# 
# mlt2020_hr[1,"lx"] = 100000
# 
# for (i in 1:nrow(mlt2020_hr)) {
#   if (mlt2020_hr[i, "lx"] > 0) {
#     mlt2020_hr[i, "dx"] = round(mlt2020_hr[i, "qx"] * mlt2020_hr[i, "lx"])
#     mlt2020_hr[i+1, "lx"] = mlt2020_hr[i, "lx"] - mlt2020_hr[i, "dx"]
#   }
# }
# mlt2020_hr  = mlt2020_hr %>% filter(!is.na(dx))
# 
# mltHr_long = data.frame(Age = rep(NA, 100000), Death = rep(1, 100000))
# 
# start = 1
# for (age in 0:(nrow(mlt2020_hr)-1)) {
#   n_row = mlt2020_hr[age+1,"dx"]
#   mltHr_long[seq(start,(n_row + start - 1)),"Age"] = age
#   start = start + n_row
# }
# 
# parameters_m_hr = data.frame(
#   Age = mlt2020_hr$Age,
#   shape=rep(NA,nrow(mlt2020_hr)),
#   rate=rep(NA,nrow(mlt2020_hr)))
# 
# for (age in 0:nrow(mlt2020_hr)-1) {
#   surv.data <- with(mltHr_long[mltHr_long$Age >= age,], Surv(Age, Death, origin=age))
#   surv.model <- flexsurvreg(surv.data ~ 1, dist="gompertz")
# 
#   parameters_m_hr$shape[age+1] <- surv.model$coefficients[1]
#   parameters_m_hr$rate[age+1] <- exp(surv.model$coefficients[2])
# }
# 
# # female
# 
# flt2020_hr = data.frame(Age = 0:(nrow(flt2020_nonCVD)-1), qx = sapply(sapply(flt2020_nonCVD$qx, ProbToRate, t = 1) * inputs$hrAfterASCVD, RateToProb, t = 1), lx = rep(0,nrow(flt2020_nonCVD)), dx = rep(NA,nrow(flt2020_nonCVD)))
# 
# flt2020_hr[1,"lx"] = 100000
# 
# for (i in 1:nrow(flt2020_hr)) {
#   if (flt2020_hr[i, "lx"] > 0) {
#     flt2020_hr[i, "dx"] = round(flt2020_hr[i, "qx"] * flt2020_hr[i, "lx"])
#     flt2020_hr[i+1, "lx"] = flt2020_hr[i, "lx"] - flt2020_hr[i, "dx"]
#   }
# }
# flt2020_hr  = flt2020_hr %>% filter(!is.na(dx))
# 
# fltHr_long = data.frame(Age = rep(NA, 100000), Death = rep(1, 100000))
# 
# start = 1
# for (age in 0:(nrow(flt2020_hr)-1)) {
#   n_row = flt2020_hr[age+1,"dx"]
#   fltHr_long[seq(start,(n_row + start - 1)),"Age"] = age
#   start = start + n_row
# }
# 
# parameters_f_hr = data.frame(
#   Age = flt2020_hr$Age,
#   shape=rep(NA,nrow(flt2020_hr)),
#   rate=rep(NA,nrow(flt2020_hr)))
# 
# for (age in 0:nrow(flt2020_hr)-1) {
#   surv.data <- with(fltHr_long[fltHr_long$Age >= age,], Surv(Age, Death, origin=age))
#   surv.model <- flexsurvreg(surv.data ~ 1, dist="gompertz")
# 
#   parameters_f_hr$shape[age+1] <- surv.model$coefficients[1]
#   parameters_f_hr$rate[age+1] <- exp(surv.model$coefficients[2])
# }
# 
ageAtDeath_afterASCVD = function(currentAge, gender, inputs, patientID)
{
  # patientID = get_attribute(env,"patientID")
  currentAge_f <- floor(currentAge) #negative time to secular death issue

  # Male 1 FEMALE 2
  if(gender == 2)
  {
    shape <- parameters_f_hr$shape[currentAge_f+1]
    rate  <- parameters_f_hr$rate[currentAge_f+1]
    age = min(currentAge + ifelse(is.null(inputs$randomNums), rgompertz(1, shape, rate), qgompertz(inputs$randomNums[(patientID-1)*length(rCRN) + rCRN["rDeathAfterASCVD"]], shape, rate)), max(parameters_f_hr$Age))
  }
  else
  {
    shape <- parameters_m_hr$shape[currentAge_f+1]
    rate  <- parameters_m_hr$rate[currentAge_f+1]
    age = min(currentAge + ifelse(is.null(inputs$randomNums), rgompertz(1, shape, rate), qgompertz(inputs$randomNums[(patientID-1)*length(rCRN) + rCRN["rDeathAfterASCVD"]], shape, rate)), max(parameters_m_hr$Age))
  }

  age
}
# 
# save(parameters_f, parameters_m, parameters_f_hr, parameters_m_hr, file = "life table/MarkovCVD_gompertz.RData")

load("life table/MarkovCVD_gompertz.RData")
```

## PCE

We use the pooled cohort equation to calculate the risk of CVD from risk factors.

<https://github.com/spgarbet/desdt/tree/main/framingham>

```{r Pooled-Cohort}
source('pcr.R')
# # the probability are percents!!
```

## Sample population

We use NHANES study for the simulated population (limited by the PCE limits).

Use the 2017-2018 version: <https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?BeginYear=2017>

```{r nhanes-clearance}
## SEQN: Respondent sequence number
# Examination: Body Measures
## BMXBMI - Body Mass Index (kg/m**2)
## 12.3 to 86.2	Range of Values
## .	Missing
nhanes_data_1 = data.frame(read_xpt("./NHANES/BMX_J.XPT", col_select = c("SEQN","BMXBMI")))
# Lab: Glycohemoglobin
## LBXGH: Glycohemoglobin (%)
nhanes_data_2 = data.frame(read_xpt("./NHANES/GHB_J.XPT", col_select = c("SEQN","LBXGH")))
# Examination: Blood Pressure
## BPXSY1 - Systolic: Blood pres (1st rdg) mm Hg
## BPXDI1 - Diastolic: Blood pres (1st rdg) mm Hg
## 0 to 136	Range of Values
## .	Missing
nhanes_data_3 = data.frame(read_xpt("./NHANES/BPX_J.XPT", col_select = c("SEQN","BPXDI1","BPXSY1")))
# Demographic Variables and Sample Weights
## RIAGENDR - Gender
## 1	Male
## 2	Female	
## .	Missing
## RIDAGEYR - Age in years at screening
## 0 to 79	Range of Values
## 80	80 years of age and over
## .	Missing

## RIDRETH1 - Race/Hispanic origin
## 1	Mexican American	1367	1367	
## 2	Other Hispanic	820	2187	
## 3	Non-Hispanic White	3150	5337	
## 4	Non-Hispanic Black	2115	7452	
## 5	Other Race - Including Multi-Racial	1802	9254	
## .	Missing

## WTMEC2YR - Full sample 2 year MEC exam weight
## 2566.1838545 to 419762.83649	Range of Values
## 0	Not MEC Examined
## .	Missing
nhanes_data_4 = data.frame(read_xpt("./NHANES/DEMO_J.XPT", col_select = c("SEQN","RIDAGEYR","RIAGENDR","RIDRETH1","WTMEC2YR"))) #WTMEC2YR is the sample weights variable
# Questionnaire: Diabetes
## DIQ010 - Doctor told you have diabetes
## 1	Yes
## 2	No
## 3	Borderline
## 7	Refused
## 9	Don't know
## .	Missing
nhanes_data_5 = data.frame(read_xpt("./NHANES/DIQ_J.XPT", col_select = c("SEQN","DIQ010")))
# Lab: Cholesterol - High - Density Lipoprotein
## LBDHDD: Direct HDL-Cholesterol (mg/dL)
nhanes_data_6 = data.frame(read_xpt("./NHANES/HDL_J.XPT", col_select = c("SEQN","LBDHDD")))
# Questionnaire: medical conditions
## MCQ160d: Ever told you had angina/angina pectoris
## MCQ160e: Ever told you had heart attack
## MCQ160f: Ever told you had a stroke
## 1	Yes
## 2	No
## 7	Refused	
## 9	Don't know
## .	Missing
nhanes_data_7 = data.frame(read_xpt("./NHANES/MCQ_J.XPT", col_select = c("SEQN","MCQ160D","MCQ160F","MCQ160E")))
# Questionnaire: Smoking - Cigarette Use
## SMQ040: Do you now smoke cigarettes?
## 1	Every day
## 2	Some days
## 3	Not at all	
## 7	Refused
## 9	Don't know
## .	Missing
nhanes_data_8 = data.frame(read_xpt("./NHANES/SMQ_J.XPT", col_select = c("SEQN","SMQ040")))
# Lab: Cholesterol - Total
## LBXTC: Total Cholesterol (mg/dL)
nhanes_data_9 = data.frame(read_xpt("./NHANES/TCHOL_J.XPT", col_select = c("SEQN","LBXTC")))
nhanes_data_10 = data.frame(read_xpt("./NHANES/BPQ_J.XPT", col_select = c("SEQN", "BPQ050A")))
# Lab: Cholesterol - Low-Density Lipoproteins (LDL)
## LBDLDL - LDL-Cholesterol, Friedewald (mg/dL)
nhanes_data_11 = data.frame(read_xpt("./NHANES/TRIGLY_J.XPT", col_select = c("SEQN", "LBDLDL")))

nhanes_data_raw <- list(nhanes_data_1,nhanes_data_2,nhanes_data_3,nhanes_data_4,
                        nhanes_data_5,nhanes_data_6,nhanes_data_7,nhanes_data_8,
                        nhanes_data_9,nhanes_data_10,nhanes_data_11)
nhanes_data_raw <- data.frame(reduce(nhanes_data_raw, full_join, by='SEQN'))
nhanes_pop = nhanes_data_raw %>%
  # whether needs to check missing data
  filter(WTMEC2YR != 0 & RIDAGEYR >= 40 & RIDAGEYR <= 79 & LBXTC >= 30 & LBXTC <= 500 & LBDHDD >= 5 & LBDHDD <= 200 & BPXSY1 >= 60 & BPXSY1 <= 200) %>%
  drop_na() %>%
  mutate(RIDRETH1 = ifelse(RIDRETH1 == 3, 1, ifelse(RIDRETH1 == 4, 2, ifelse(RIDRETH1 %in% c(1,2), 3, 4))))

nhanes_pop$cum_weight = cumsum(nhanes_pop$WTMEC2YR / sum(nhanes_pop$WTMEC2YR))

race = 1:4
names(race) = c("White", "African American", "Hispanic", "Other")
race_convert = function(num) {
  return(names(race[num]))
}

bp_treatment = 1:2
names(bp_treatment) = c("Yes","No")

smoker = 1:3
names(smoker) = c("Every day","Some days","Not at all")

diabetic = 1:2
names(diabetic) = c("Yes","No")

save(nhanes_pop, nhanes_data_raw, file = "./NHANES/nhanes_full.RData")
```

```{r get-pop}
# for CRN, add an identifier
initialize_patient <- function(traj, inputs)
{
        traj %>%
                seize("time_in_model")       %>%
                set_attribute("patientID", function()
                  # patientID is 0-index
                  as.numeric(str_remove(get_name(env), "patient"))) %>%
                # NHANES version
                set_attribute("nhanesNo",         function() ifelse(
                  is.null(inputs$randomNums),
                  sample(1:nrow(nhanes_pop), 1, prob=1/nhanes_pop$WTMEC2YR),
                  which(nhanes_pop$cum_weight>=inputs$randomNums[(get_attribute(env,"patientID"))*length(rCRN) + rCRN["nhanesNo"]])[1])) %>%
                set_attribute("Gender",     function() nhanes_pop$RIAGENDR[get_attribute(env, "nhanesNo")]) %>%
                set_attribute("Age",        function() nhanes_pop$RIDAGEYR[get_attribute(env, "nhanesNo")]) %>% 
                set_attribute("AgeInitial", function() get_attribute(env, "Age")) %>%
                set_attribute("Race",       function() nhanes_pop$RIDRETH1[get_attribute(env, "nhanesNo")]) %>%
                set_attribute("TotChol",    function() nhanes_pop$LBXTC[get_attribute(env, "nhanesNo")]) %>%
                set_attribute("HdlChol",    function() nhanes_pop$LBDHDD[get_attribute(env, "nhanesNo")]) %>%
                set_attribute("LdlChol",   function()
nhanes_pop$LBDLDL[get_attribute(env, "nhanesNo")]) %>%
                set_attribute("SystolicBp", function() nhanes_pop$BPXSY1[get_attribute(env, "nhanesNo")]) %>%
                set_attribute("BpTreatment",function() nhanes_pop$BPQ050A[get_attribute(env, "nhanesNo")]) %>%
                set_attribute("Smoker",      function() nhanes_pop$SMQ040[get_attribute(env, "nhanesNo")]) %>%
                set_attribute("Diabetic",    function() nhanes_pop$DIQ010[get_attribute(env, "nhanesNo")]) %>%
                set_attribute("PrsZ",       function() 0) %>%
                set_attribute("PCErisk",    function()
  pcr(gender = ifelse(get_attribute(env, "Gender") == 1, 'M', 'F'),
             get_attribute(env,"AgeInitial"),
             race_convert(get_attribute(env, "Race")),
             get_attribute(env, "TotChol"),
             get_attribute(env, "HdlChol"),
             get_attribute(env, "SystolicBp"),
             (get_attribute(env, "BpTreatment") == 1),
             (get_attribute(env, "Smoker") %in% c(1,2)),
             (get_attribute(env, "Diabetic") == 1),
             get_attribute(env, "PrsZ")
             )[1]/100) %>%
                set_attribute("Strategy", function() inputs$strategy) %>%
                set_attribute("aUseStatins", function()
                  ifelse(get_attribute(env, "Strategy") == 1 &
                           (get_attribute(env, "LdlChol") >= 190 |
                            get_attribute(env, "PCErisk") >= 0.075 |
                            get_attribute(env, "Diabetic") == 1), 1, 0))
}
```

# Intervention

strategy 0. status quo(placebo)

strategy 1. add statins as 2013 ACC/AHA

Individuals(\>= 40 yr):

-   with diabetes, or

-   low-density lipoprotein cholesterol level \>= 190 mg/dl, or

-   estimated 10-year ASCVD risk greater than or equal to 7.5%.

Statins will be taken until the ASCVD happen.

Adverse events:

Adverse events will happen immediately after using statins. The major adverse event will overlap the mild adverse event. The death caused by the major adverse event should happen immediately after the event.

# DES

```{r events}
counters = c("get_CVD", "death_without_CVD", "death_of_ASCVD", "death_after_ASCVD", "statins_mild_adverse_event", "statins_major_adverse_event", "death_of_statins_adverse_event", "time_in_model")

### Note:
### As only simulate all the things once, lots of places I use the initial age instead of the updated age. 

terminate <- function(traj, inputs)
{
  traj %>%
  branch(function() 1,
         continue=FALSE,
         trajectory()               %>%
           release("time_in_model") %>%
           timeout(0)
        )
}

# # Statins events
# years_till_use_statins <- function(inputs){
#   ifelse(get_attribute(env, "Strategy") == 1 &
#                            (get_attribute(env, "LdlChol") >= 190 |
#                             get_attribute(env, "PCErisk") >= 0.075 |
#                             get_attribute(env, "Diabetic") == 1), 0, Inf)
# }
# 
# event_use_statins <- function(traj, inputs){
#   traj %>%
#     mark("use_statins")
# }

years_till_statins_mild_adverse <- function(inputs){
  if (get_attribute(env, "aUseStatins") == 1 & is.na(get_attribute(env, "aStatinsMildAdverse"))) {
      ifelse(is.null(inputs$randomNums),
      ifelse(runif(1)<inputs$pMildStatinAdverse,0, Inf),
      ifelse(inputs$randomNums[(get_attribute(env,"patientID"))*length(rCRN) + rCRN["rStatinsMildAdverse"]]<inputs$pMildStatinAdverse, 0, Inf)
      )
  } else Inf
}

event_statins_mild_adverse <- function(traj, inputs){
  traj %>% 
    mark("statins_mild_adverse_event")
}

years_till_statins_major_adverse <- function(inputs){
  if (get_attribute(env, "aUseStatins") == 1 & is.na(get_attribute(env, "aStatinsMajorAdverse"))) {
      ifelse(is.null(inputs$randomNums),
      ifelse(runif(1)<inputs$pMajorStatinAdverse,0, Inf),
      ifelse(inputs$randomNums[(get_attribute(env,"patientID"))*length(rCRN) + rCRN["rStatinsMajorAdverse"]]<inputs$pMajorStatinAdverse, 0, Inf)
      )
  } else Inf
}

event_statins_major_adverse <- function(traj, inputs){
  traj %>% 
    mark("statins_major_adverse_event")
}

years_till_death_of_statins_adverse <- function(inputs){
  time_to_major_adverse = get_attribute(env, "aStatinsMajorAdverse")
  if (!is.infinite(time_to_major_adverse)){
    ifelse(is.null(inputs$randomNums),
    ifelse(runif(1)<inputs$pMajorStatinAdverseBeingFatal, time_to_major_adverse +0, Inf),
    ifelse(inputs$randomNums[(get_attribute(env,"patientID"))*length(rCRN) + rCRN["rDeathOfStatinsAdverse"]] < inputs$pMajorStatinAdverseBeingFatal, time_to_major_adverse+0, Inf))
  } else Inf
}

event_death_of_statins_adverse <- function(traj, inputs){
   traj %>% 
    set_attribute("AgeDeathStatinsAdverse", function() get_attribute(env,"aDeathOfStatinsAdverse") + get_attribute(env,"AgeInitial")) %>%
    branch(
    function() 1,
    continue=c(TRUE),
    trajectory("Death associated with major adverse events") %>%
      mark("death_of_statins_adverse_event") %>%
      terminate(inputs)
  )
}

## CVD events

years_till_death_without_CVD <- function(inputs)
{
  age       <- get_attribute(env, 'Age')
  gender    <- get_attribute(env, 'Gender')
  patientID <- get_attribute(env, 'patientID')
  
  deathAge = ageAtDeath(age, gender, inputs, patientID)
  
  ## the if-else here make sure that if get CVD firstly, will never die of 1.0 BG mortality
  
  return(ifelse(get_attribute(env, "aGetCVD") < deathAge - age, Inf, deathAge - age))
}

event_death_without_CVD <- function(traj, inputs)
{
  cat("event_Death() ", now(env), "\n")
  
  traj %>% 
    set_attribute("AgeDeathNonCVD", function() get_attribute(env,"aDeathWithoutCVD") + get_attribute(env,"AgeInitial")) %>%
    branch(
    function() 1,
    continue=c(TRUE),
    trajectory("Death without CVD") %>%
      mark("death_without_CVD") %>%
      terminate(inputs)
  )
}

years_till_get_CVD <- function(inputs)
{
  gender = ifelse(get_attribute(env, "Gender") == 1, "M", "F")
  race_pcr = race_convert(get_attribute(env, "Race")) 
  
  prob = get_attribute(env, "PCErisk")
  rr = ifelse(inputs$strategy == 1, inputs$rrStatinsASCVD, 1)
  
  # 10-year probability to 1-year rate
  years = ifelse(is.null(inputs$randomNums), rexp(1,ProbToRate(prob, 10)*rr), qexp(inputs$randomNums[(get_attribute(env,"patientID"))*length(rCRN) + rCRN["rGetCVD"]], ProbToRate(prob, 10)*rr))
  
  return(ifelse(is.na(get_attribute(env, "aGetCVD")), years, Inf))
}

event_get_CVD = function(traj, inputs) {
  cat("event_get_CVD() ", now(env), "\n")

  traj %>%
    set_attribute("AgeCVD", function() get_attribute(env,"AgeInitial") + get_attribute(env, "aGetCVD")) %>%
    branch(
    function() 1,
    continue=c(TRUE),
    trajectory("Get CVD") %>%
      mark("get_CVD"))
}

years_till_death_of_ASCVD = function(inputs) {
  
  ageCVD    <- get_attribute(env, 'aGetCVD') + get_attribute(env, "AgeInitial")
  gender    <- get_attribute(env, 'Gender')
  
  ## getCVD maybe sth really big.
  
  age_max = ifelse(gender == 1, max(parameters_m_hr$Age), max(parameters_f_hr$Age))
  
  if (ageCVD >= age_max - 1) {
    # not able to use ageAtDeath(ageCVD+1, gender)
    years = get_attribute(env, 'aGetCVD')
  } else {
    ## ageCVD under the age limitation -- able to use gomepertz
    # whether ASCVD died in first year happened
    happen = 0
    if (gender == 1) {
      ## men
      if (ageCVD < 65) {
        happen = ifelse(is.null(inputs$randomNums),
                        sample(0:1, 1, prob = c(1-inputs$mortalityFirstYearASCVD_male_young, inputs$mortalityFirstYearASCVD_male_young)),
                        ifelse(inputs$randomNums[(get_attribute(env,"patientID"))*length(rCRN) + rCRN["rDeathOfASCVD"]] < inputs$mortalityFirstYearASCVD_male_young, 1, 0))
        } else {
          happen = ifelse(is.null(inputs$randomNums),
                        sample(0:1, 1, prob = c(1-inputs$mortalityFirstYearASCVD_male_old, inputs$mortalityFirstYearASCVD_male_old)),
                        ifelse(inputs$randomNums[(get_attribute(env,"patientID"))*length(rCRN) + rCRN["rDeathOfASCVD"]] < inputs$mortalityFirstYearASCVD_male_old, 1, 0))
          }
      } else {
        ## women
        if (ageCVD < 65) {
          happen = ifelse(is.null(inputs$randomNums),
                        sample(0:1, 1, prob = c(1-inputs$mortalityFirstYearASCVD_female_young, inputs$mortalityFirstYearASCVD_female_young)),
                        ifelse(inputs$randomNums[(get_attribute(env,"patientID"))*length(rCRN) + rCRN["rDeathOfASCVD"]] < inputs$mortalityFirstYearASCVD_female_young, 1, 0))
          } else {
            happen = ifelse(is.null(inputs$randomNums),
                        sample(0:1, 1, prob = c(1-inputs$mortalityFirstYearASCVD_female_old, inputs$mortalityFirstYearASCVD_female_old)),
                        ifelse(inputs$randomNums[(get_attribute(env,"patientID"))*length(rCRN) + rCRN["rDeathOfASCVD"]] < inputs$mortalityFirstYearASCVD_female_old, 1, 0))
          }
      }
    years = ifelse(happen == 1, get_attribute(env, "aGetCVD") + 0.5, Inf)
  }
  
  return(years)
}

event_death_of_ASCVD = function(traj, inputs) {
  traj %>%
    set_attribute("AgeDeathCVD", function() get_attribute(env, "AgeInitial") + now(env)) %>%
    branch(
    function() 1,
    continue=c(TRUE),
    trajectory("Death of first-year ASCVD") %>%
      mark("death_of_ASCVD") %>%
      terminate(inputs)
    )
  }

years_till_death_after_ASCVD <- function(inputs) {
  # whether die of ASCVD(in <= 1 yr)
  if (is.infinite(get_attribute(env, 'aDeathOfASCVD'))) {
  
    ageCVD    <- get_attribute(env, 'aGetCVD') + get_attribute(env, "AgeInitial")
    gender    <- get_attribute(env, 'Gender')
    patientID <- get_attribute(env, 'patientID')

    deathAge = ageAtDeath_afterASCVD(ageCVD + 1, gender, inputs, patientID)
  
    # GetCVD + ageInitial maybe a impossible number
    years = deathAge - get_attribute(env, "AgeInitial")
  
  } else {
    years = Inf
  }
  
  return(years)
}

event_death_after_ASCVD = function(traj, inputs) {
  cat("event_death_with_CVD", now(env), "\n")
  
  traj %>% 
    set_attribute("AgeDeathCVD", function() get_attribute(env, "AgeInitial")+now(env)) %>%
    branch(
    function() 1,
    continue=c(TRUE),
    trajectory("Death after ASCVD event") %>%
      mark("death_after_ASCVD") %>%
      terminate(inputs)
    )
}

event_registry <- list(
        list(name          = "Get CVD",
             attr          = "aGetCVD",
             time_to_event = years_till_get_CVD,
             func          = event_get_CVD,
             reactive      = FALSE),
        list(name          = "Death without CVD",
             attr          = "aDeathWithoutCVD",
             time_to_event = years_till_death_without_CVD,
             func          = event_death_without_CVD,
             reactive      = FALSE),
        list(name          = "Death of ASCVD",
             attr          = "aDeathOfASCVD",
             time_to_event = years_till_death_of_ASCVD,
             func          = event_death_of_ASCVD,
             reactive      = FALSE),
        list(name          = "Death after ASCVD",
             attr          = "aDeathAfterASCVD",
             time_to_event = years_till_death_after_ASCVD,
             func          = event_death_after_ASCVD,
             reactive      = FALSE),
        list(name          = "Halt at time horizon",
             attr          = "aTerminate",
             time_to_event = function(inputs) inputs$vHorizon,
             func          = terminate,
             reactive      = FALSE),
        # list(name          = "Use Statins",
        #      attr          = "aUseStatins",
        #      time_to_event = years_till_use_statins,
        #      func          = event_use_statins,
        #      reactive      = FALSE),
        list(name          = "Mild Adverse for Statins",
             attr          = "aStatinsMildAdverse",
             time_to_event = years_till_statins_mild_adverse,
             func          = event_statins_mild_adverse,
             reactive      = FALSE),
        list(name          = "Major Adverse for Statins",
             attr          = "aStatinsMajorAdverse",
             time_to_event = years_till_statins_major_adverse,
             func          = event_statins_major_adverse,
             reactive      = FALSE),
        list(name          = "Death of Major Adverse for Statins",
             attr          = "aDeathOfStatinsAdverse",
             time_to_event = years_till_death_of_statins_adverse,
             func          = event_death_of_statins_adverse,
             reactive      = FALSE)
)
## aAgeCVD is not immediately(only get after this happen), but aGetCVD happens at 0.

## in this way there'll be 2 aGetCVD
## because if getCVD is inside the horizon, there'll be repeats. for the first version, they just died/terminated. 
```

## run

Two versions of event_registry --

```{r run}
source("DES.R")

env = simmer("CVD")

exec.simulation <- function(inputs)
{
        #set.seed(11451428)
        env  <<- simmer("CVD")
        traj <- simulation(env, inputs)
        env %>% create_counters(counters)
        
        env %>%
                add_generator("patient", traj, at(rep(0, inputs$vN)), mon=2) %>%
                run(inputs$vHorizon+1e-6) %>% # Simulate just past horizon
                wrap()
        
        get_mon_arrivals(env, per_resource = T)
}

results <- NULL
attributes <- NULL

for (strategy in 0:1){
  inputs$strategy = strategy
  
  run <- exec.simulation(inputs)
  run$strategy <- strategy
  
  at <- arrange(get_mon_attributes(env),name,key,time) #obtain attributes data
  at$strategy <- strategy
  
  if(is.null(results)) { results <- run } else  {results <- rbind(results, run)}
  if(is.null(attributes)) { attributes <- at } else  {attributes <- rbind(attributes, at)}
  rm(run)
  rm(at)
}
```

## results

Solve the repeat events by requiring the value to be NA previously:

-   Get CVD

-   Mild Adverse Events

-   Major Adverse Events

```{r results}
# detach("package:simmer", unload=TRUE)

# attributes
# as the ageCVD might be over 79, ageCVDagain is not correct. 
# aGetCVD and aAgeCVD only draw the first time. 

# repeated get CVD, only draw the first time
# repeatNames = attributes %>% 
#   filter(time != 0 & key == "aGetCVD") %>%
#   select(name) %>% unique(.) 
# 
# molten = repeatNames %>% left_join(attributes, by = "name") %>%
#   filter(key == "aGetCVD" | key == "AgeCVD") %>%
#   group_by(name, key) %>%
#   summarize(time = min(time)) %>% 
#   left_join(attributes %>% filter(key == "AgeCVD" | key == "aGetCVD") %>% select(-replication), by = c("name", "key", "time")) %>% 
#   rbind(attributes %>% filter(name %in% repeatNames$name & !(key %in% c("AgeCVD", "aGetCVD"))) %>% select(-replication)) %>%
#   rbind(attributes %>% filter(!(name %in% repeatNames$name)) %>% select(-replication)) %>%
#   select(-time)
# casted = dcast(molten, name ~ key)

repeatSets = attributes %>% filter((key == "aGetCVD" | key == "aStatinsMildAdverse" | key == "aStatinsMajorAdverse") & is.infinite(value))

casted = setdiff(attributes, repeatSets) %>% select(-replication, -time) %>% spread(key, value)

```

```{r patient-group}
## Die of Major Adverse Events for Statins
casted %>% filter(aDeathOfStatinsAdverse == min(aGetCVD, aDeathWithoutCVD, aDeathOfStatinsAdverse, aTerminate))

## 1. never get CVD, never die before horizon. 
casted %>% filter(is.na(AgeCVD) & is.na(AgeDeathNonCVD)) %>%
  head(10) %>%
  kable(caption = "1. never get CVD, never die before horizon.") %>%
  kable_styling() %>%
  scroll_box(height = "400px")

## 2. never get CVD, die of background mortality before horizon
casted %>% filter(is.na(AgeCVD) & !is.na(AgeDeathNonCVD)) %>%
  head(10) %>%
  kable(caption = "2. never get CVD, die of background mortality before horizon") %>%
  kable_styling() %>%
  scroll_box(height = "400px")

## 3. get CVD, survive till horizon
casted %>% filter(!is.na(AgeCVD) & is.na(AgeDeathCVD)) %>%
  head(10) %>%
  kable(caption = "3. get CVD, survive till horizon") %>%
  kable_styling() %>%
  scroll_box(height = "400px")

## 4. get CVD, die of first-year ASCVD
casted %>% filter(!is.na(AgeCVD) & !is.na(AgeDeathCVD) & aDeathOfASCVD == 0.5 + aGetCVD) %>%
  head(10) %>%
  kable(caption = "4. get CVD, die of first-year ASCVD") %>%
  kable_styling() %>%
  scroll_box(height = "400px")

## 5. get CVD, die after first-year ASCVD event
casted %>% filter(!is.na(AgeCVD) & !is.na(AgeDeathCVD) & is.finite(aDeathAfterASCVD)) %>%
  head(10) %>%
  kable(caption = "5. get CVD, die after first-year ASCVD event") %>%
  kable_styling() %>%
  scroll_box(height = "400px")
```

# Unsolved Question and Check

## Updated death age

What if DeathWithCVD bigger than DeathWithoutCVD, but the person get CVD before death -- it is like that a person get into another distribution(or you can say fate) after getting CVD.

But for the consistency of 1.9, just use the newest DeathWithCVD.

```{r question}
## exception1: get CVD, die of initial background mortality
casted %>% filter(!is.na(AgeCVD) & !is.na(AgeDeathNonCVD)) %>%
  kable(caption = "get CVD, die of initial background mortality") %>%
  kable_styling()

# casted %>% filter(GetCVD < aDeathWithoutCVD & AgeDeathCVD > AgeInitial + aDeathWithoutCVD)
```

## die with/die of

## repeat getting CVD

```{r repeat}
# results %>% filter(resource == "time_in_model") %>% mutate(time_in_model = activity_time) %>% select(name, time_in_model)

repeatNames2 = results %>% filter(resource != "time_in_model") %>% count(name, resource) %>% filter(n > 1) %>% pull(name)

# attributes %>% filter(name %in% repeatNames2) %>% filter(time > 0)
# there will no repeated death_with_CVD because the repeat will only happen after the event happen, but for death the event will terminate all. 
```

# Cost-Effectiveness Analysis

All events continues for 0s except time_in_model. Results only include all things that really happen.

```{r trace}
# trace = results %>% filter(name %in% repeatNames2 & resource == "get_CVD") %>% group_by(name, resource) %>% summarize(start_time = min(start_time)) %>%
#   rbind(results %>% filter(!(name %in% repeatNames2) | resource != "get_CVD") %>%
#           filter(resource != "time_in_model") %>%
#           select(name, resource, start_time)) %>%
#   spread(key = resource, value= start_time) %>%
#   full_join(results %>% filter(resource == "time_in_model") %>% mutate(time_in_model = activity_time) %>% select(name, time_in_model), by = "name") %>%
#   left_join(casted %>% select(name, initial_age = aAgeInitial), by = "name")

# trace %>% filter(get_CVD == death_of_ASCVD)

trace = results %>% select(-start_time, -activity_time, -replication) %>% spread(resource, end_time) %>% 
  left_join(casted %>% select(name, strategy, statins_use = aUseStatins, initial_age = AgeInitial), by = c("name", "strategy"))

if (is.null(trace$statins_major_adverse_event)) {trace$statins_major_adverse_event = NA}
```

##Status QUO CEA

1.  never get CVD, never die before horizon.\
    **cost**: inputs\$cHealthcareNonCVD \* trace\$time_in_model\
    **payoff**: inputs\$uHealthy \* trace\$time_in_model

2.  never get CVD, die of background mortality before horizon\
    **cost**: inputs\$cHealthcareNonCVD \* trace\$time_in_model\
    **payoff**: inputs\$uHealthy \* trace\$time_in_model

3.  get CVD, survive till horizon\
    **cost**: inputs\$cHealthcareNonCVD \* trace\$time_in_model + inputs\$cNonFatalASCVD + inputs\$cAnnualFU_afterASCVD \* (trace\$time_in_model - trace\$get_CVD - 1)\
    **payoff**: inputs\$uHealthy \* trace\$get_CVD + inputs\$uAfterASCVD\*(trace\$time_in_model - trace\$get_CVD)

4.  get CVD, die of first-year ASCVD\
    **cost**: inputs\$cHealthcareNonCVD \* trace\$time_in_model + inputs\$cFatalASCVD\
    **payoff**: inputs\$uHealthy \* trace\$get_CVD + inputs\$uAfterASCVD\*(trace\$time_in_model - trace\$get_CVD)

5.  get CVD, die after first-year ASCVD event\
    **cost**: inputs\$cHealthcareNonCVD \* trace\$time_in_model + inputs\$cNonFatalASCVD + inputs\$cAnnualFU_afterASCVD \* (trace\$time_in_model - trace\$get_CVD - 1)\
    **payoff**: inputs\$uHealthy \* trace\$get_CVD + inputs\$uAfterASCVD\*(trace\$time_in_model - trace\$get_CVD)

## Statins CEA

```{r cost-utility-func}
basic_CVD_costs = function(inputs, death_after_ASCVD, death_of_ASCVD, death_without_CVD, get_CVD, time_in_model, initial_age) {
  cost = 0
  ##cHealthcareNonCVD
  if (initial_age < 45) {
    cost = cost + inputs$rInflation2019 * inputs$cHealthcareNonCVD_18_44 * (min(45, time_in_model + initial_age) - initial_age) + inputs$rInflation2019 * inputs$cHealthcareNonCVD_45_64 * (max(time_in_model + initial_age, 45) - 45)
  } else if (initial_age >= 45 & initial_age < 55) {
    cost = cost + inputs$rInflation2019 * inputs$cHealthcareNonCVD_45_64 * time_in_model
  } else if (initial_age >= 55 & initial_age < 65) {
    cost = cost + inputs$rInflation2019 * inputs$cHealthcareNonCVD_45_64 * (min(65, time_in_model + initial_age) - initial_age) + inputs$rInflation2019 * inputs$cHealthcareNonCVD_65 * (max(time_in_model + initial_age, 65) - 65)
  } else {
    cost = cost + inputs$rInflation2019 * inputs$cHealthcareNonCVD_65 * time_in_model
  }
  
  # FatalASCVD
  if(!is.na(get_CVD) & !is.na(death_of_ASCVD)) {
    cost = cost + inputs$rInflation2017 * inputs$cFatalASCVD
  }
  
  # Non-Fatal ASCVD
  if(!is.na(get_CVD) & is.na(death_of_ASCVD)) {
    cost = cost + inputs$rInflation2017 * inputs$cNonFatalASCVD + inputs$rInflation2017 * inputs$cAnnualFU_afterASCVD * (time_in_model - get_CVD - 1)
  }
  return(cost)
}

adjustment_statins_costs = function(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model){
  if (statins_use == 1){
    inputs$cAnnualStatin * min(get_CVD, time_in_model) * inputs$rInflation2017 + 
    ifelse(!is.na(statins_major_adverse_event), inputs$cMajorStatinAdverse, ifelse(!is.na(statins_mild_adverse_event), inputs$cMildStatinAdverse, 0))
  } else 0
}

# basic_CVD_utilties = function(inputs, get_CVD, time_in_model){
#   if (is.na(get_CVD)) {
#     utility = inputs$uHealthy * time_in_model
#   } else {
#     utility = inputs$uHealthy * get_CVD + inputs$uAfterASCVD * (time_in_model - get_CVD)
#   }
#   return(utility)
# }

adjusted_statins_utilities = function(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model){
  if (statins_use == 1) {
    if (!is.na(statins_major_adverse_event)){
      uStatins = inputs$uHealthyStatin - inputs$uPenaltyMajorStatinAdverse
    } else if (!is.na(statins_mild_adverse_event)) {
      uStatins = inputs$uHealthyStatin - inputs$uPenaltyMildStatinAdverse
    } else {
      uStatins = inputs$uHealthyStatin
    }
    
    if (is.na(get_CVD)) {uStatins * time_in_model}
    else { uStatins * get_CVD + inputs$uAfterASCVD * (time_in_model - get_CVD)}
  
    } else {
    if (is.na(get_CVD)) {return(inputs$uHealthy * time_in_model)
    } else {return(inputs$uHealthy * get_CVD + inputs$uAfterASCVD * (time_in_model - get_CVD))}
  }
}
```

```{r cea}
patientWcea = trace %>% 
  rowwise() %>%
  mutate(
  cost = basic_CVD_costs(inputs, death_after_ASCVD, death_of_ASCVD, death_without_CVD, get_CVD, time_in_model, initial_age),
  #+ adjustment_statins_costs(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model),
  utility = adjusted_statins_utilities(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model),
    )

patientWcea %>%
  kable(caption = "trace of simulated individuals with undiscounted cost and utilities") %>%
  kable_styling() %>%
  scroll_box(height = "400px")

strategyWcea = patientWcea %>% 
  group_by(strategy) %>%
    summarize(
      time_in_model = mean(time_in_model),
      cost = mean(cost), 
      QALY = mean(utility)) %>%
  mutate(strategy = ifelse(strategy == 1, "Statins(2013 ACC/AHA)", "Status Quo"))

df_cea = calculate_icers(cost = strategyWcea$cost,
                         effect = strategyWcea$QALY,
                         strategies = strategyWcea$strategy)

df_cea

## CEA frontier -----
# depends on the `ggplot2`  and `ggrepel` packages.
# Function included in "Functions_markov.R"
plot(df_cea, label = "all", txtsize = 16) +
  expand_limits(x = max(df_cea$QALY) + 0.1) +
  theme(legend.position = c(0.8, 0.2))
```

## Discounting

work-on

```{r check}
# pcr(ifelse(casted[2,"Gender"] == 1, "M", "F"), 
#     casted[2, "AgeInitial"],
#     race_convert(casted[2, "Race"]),
#     casted[2, "TotChol"],
#     casted[2, "HdlChol"],
#     casted[2, "SystolicBp"],
#     casted[2, "BpTreatment"] == 1,
#     casted[2, "Smoker"] %in% c(1,2),
#     casted[2, "Diabetic"] == 1,
#     casted[2, "PrsZ"]
#     )
# 
# attributes %>% filter(key == "AgeDeath") %>% inner_join(attributes %>% filter(key == "AgeDeathCVD"), by = "name")
# attributes %>% filter(key == "AgeCVD") %>% inner_join(attributes %>% filter(key == "AgeDeathCVD"), by = "name")
# results %>% filter(resource == "time_in_model")
# 
# ## all the events should count from time 0 
# casted %>% filter(aDeathAfterASCVD + aAgeInitial == aAgeDeathCVD)
# 
# cHealthcareNonCVD = function(inputs, time_in_model, initial_age){
#   cost = 0
#   if (initial_age < 45) {
#     cost = cost + inputs$cHealthcareNonCVD_18_44 * (min(45, time_in_model + initial_age) - initial_age) + inputs$cHealthcareNonCVD_45_64 * (max(time_in_model + initial_age, 45) - 45)
#   } else if (initial_age >= 45 & initial_age < 55) {
#     cost = cost + inputs$cHealthcareNonCVD_45_64 * time_in_model
#   } else if (initial_age >= 55 & initial_age < 65) {
#     cost = cost + inputs$cHealthcareNonCVD_45_64 * (min(65, time_in_model + initial_age) - initial_age) + inputs$cHealthcareNonCVD_65 * (max(time_in_model + initial_age, 65) - 65)
#   } else {
#     cost = cost + inputs$cHealthcareNonCVD_65 * time_in_model
#   }
#   return(cost)
# }
# 
# trace %>%
#   mutate(cHealthcareNonCVD = cHealthcareNonCVD(inputs, time_in_model, initial_age))

```

# Common Random Number Check

random draws

```{r draws}
source("random_draws_for_CVD_PSAs.R")

RIPS_CVD_run = function(inputs){
  results <- NULL
  attributes <- NULL
  #outputs <- list()

  for (strategy in 0:1){
    inputs$strategy = strategy
  
    run <- exec.simulation(inputs)
    run$strategy <- strategy
  
    at <- arrange(get_mon_attributes(env),name,key,time) #obtain attributes data
    at$strategy <- strategy
  
    if(is.null(results)) { results <- run } else  {results <- rbind(results, run)}
    if(is.null(attributes)) { attributes <- at } else  {attributes <- rbind(attributes, at)}
    rm(run)
    rm(at)
  }
  
  repeatSets = attributes %>% filter((key == "aGetCVD" | key == "aStatinsMildAdverse" | key == "aStatinsMajorAdverse") & is.infinite(value))

  casted = setdiff(attributes, repeatSets) %>% select(-replication, -time) %>% spread(key, value)
  
  trace = results %>% select(-start_time, -activity_time, -replication) %>% spread(resource, end_time) %>% 
  left_join(casted %>% select(name, strategy, statins_use = aUseStatins, initial_age = AgeInitial), by = c("name", "strategy"))

  if (is.null(trace$statins_major_adverse_event)) {trace$statins_major_adverse_event = NA}
  
  patientWcea = trace %>% 
    rowwise() %>%
    mutate(
      cost = basic_CVD_costs(inputs, death_after_ASCVD, death_of_ASCVD, death_without_CVD, get_CVD, time_in_model, initial_age),
  #+ adjustment_statins_costs(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model),
      utility = adjusted_statins_utilities(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model))

  strategyWcea = patientWcea %>% 
    group_by(strategy) %>%
      summarize(
        time_in_model = mean(time_in_model),
        cost = mean(cost), 
        QALY = mean(utility)) %>%
    mutate(strategy = ifelse(strategy == 1, "Statins(2013 ACC/AHA)", "Status Quo"))

  df_cea = calculate_icers(cost = strategyWcea$cost,
                         effect = strategyWcea$QALY,
                         strategies = strategyWcea$strategy)

#   outputs$results = results
#   outputs$attributes = attributes
#   outputs$df_cea = df_cea
  return(df_cea)
} 
```

```{r test}
o1 = RIPS_CVD_run(params_CRN)
o2 = RIPS_CVD_run(params_CRN)

repeatSets1 = o1$attributes %>% filter((key == "aGetCVD" | key == "aStatinsMildAdverse" | key == "aStatinsMajorAdverse") & is.infinite(value))

  casted1 = setdiff(o1$attributes, repeatSets1) %>% select(-replication, -time) %>% spread(key, value)
  
  trace1 = o1$results %>% select(-start_time, -activity_time, -replication) %>% spread(resource, end_time) %>% 
  left_join(casted1 %>% select(name, strategy, statins_use = aUseStatins, initial_age = AgeInitial), by = c("name", "strategy"))

  if (is.null(trace1$statins_major_adverse_event)) {trace1$statins_major_adverse_event = NA}

repeatSets2 = o2$attributes %>% filter((key == "aGetCVD" | key == "aStatinsMildAdverse" | key == "aStatinsMajorAdverse") & is.infinite(value))

  casted2 = setdiff(o2$attributes, repeatSets1) %>% select(-replication, -time) %>% spread(key, value)
  
  trace2 = o2$results %>% select(-start_time, -activity_time, -replication) %>% spread(resource, end_time) %>% 
  left_join(casted2 %>% select(name, strategy, statins_use = aUseStatins, initial_age = AgeInitial), by = c("name", "strategy"))

  if (is.null(trace2$statins_major_adverse_event)) {trace2$statins_major_adverse_event = NA}
  
which(trace1 != trace2, arr.ind = TRUE)
  
  patientWcea = trace %>% 
    rowwise() %>%
    mutate(
      cost = basic_CVD_costs(inputs, death_after_ASCVD, death_of_ASCVD, death_without_CVD, get_CVD, time_in_model, initial_age),
  #+ adjustment_statins_costs(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model),
      utility = adjusted_statins_utilities(inputs, statins_use, statins_mild_adverse_event, statins_major_adverse_event, get_CVD, time_in_model))

  strategyWcea = patientWcea %>% 
    group_by(strategy) %>%
      summarize(
        time_in_model = mean(time_in_model),
        cost = mean(cost), 
        QALY = mean(utility)) %>%
    mutate(strategy = ifelse(strategy == 1, "Statins(2013 ACC/AHA)", "Status Quo"))


```

```{r dsa-way}

```

## Without CRN

```{r woCRN}
params_PSA = params
rrStatinsASCVD_1000draws = randomDraw("rrStatinsASCVD",params_PSA,1000)

results_woCRN = list()
results_woCRN$statins = data.frame(NULL)
results_woCRN$quo = data.frame(NULL)

for (i in 1:1000){
  print(paste0(i))
  params_PSA$rrStatinsASCVD = rrStatinsASCVD_1000draws[i]
  
  time_start <- Sys.time()
  result = RIPS_CVD_run(params_PSA)
  time_end <- Sys.time()
  
  result = result %>%
    mutate(NHB = Effect*params_PSA$wtp - Cost,
           rrStatinsASCVD = rrStatinsASCVD_100draws[i],
           time = time_end - time_start)
  
    if(is.null(results_woCRN$statins)){
      results_woCRN$statins <- result[result$Strategy == "Statins(2013 ACC/AHA)",]
    } else {results_woCRN$statins <- rbind.data.frame(results_woCRN$statins, result[result$Strategy == "Statins(2013 ACC/AHA)",])}
  
  if(is.null(results_woCRN$quo)){
      results_woCRN$quo <- result[result$Strategy == "Status Quo",]
  } else {results_woCRN$quo <- rbind.data.frame(results_woCRN$quo, result[result$Strategy == "Status Quo",])}
  
}

results_woCRN$statins %>%
  ggplot(aes(x = rrStatinsASCVD, y = Effect)) +
  geom_line()
```

## With CRN

```{r wCRN}
params_PSA = params_CRN
rrStatinsASCVD_1000draws = randomDraw("rrStatinsASCVD",params_PSA,1000)

results_wCRN = list()
results_wCRN$statins = data.frame(NULL)
results_wCRN$quo = data.frame(NULL)

for (i in 1:1000){
  print(paste0(i))
  params_PSA$rrStatinsASCVD = rrStatinsASCVD_100draws[i]
  
  time_start = Sys.time()
  result = RIPS_CVD_run(params_PSA)
  time_end = Sys.time()
  result = result %>%
    mutate(NHB = Effect*params_PSA$wtp - Cost,
           rrStatinsASCVD = rrStatinsASCVD_100draws[i],
           time = time_end - time_start)
  
    if(is.null(results_wCRN$statins)){
      results_wCRN$statins <- result[result$Strategy == "Statins(2013 ACC/AHA)",]
    } else {results_wCRN$statins <- rbind.data.frame(results_wCRN$statins, result[result$Strategy == "Statins(2013 ACC/AHA)",])}
  
  if(is.null(results_wCRN$quo)){
      results_wCRN$quo <- result[result$Strategy == "Status Quo",]
  } else {results_wCRN$quo <- rbind.data.frame(results_wCRN$quo, result[result$Strategy == "Status Quo",])}
  
}

results_wCRN$statins %>%
  ggplot(aes(x = rrStatinsASCVD, y = Effect)) +
  geom_line()
```
